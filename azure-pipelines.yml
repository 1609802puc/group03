trigger:
- main

pool:
  name: Default_2
  demands:
    - Agent.Name -equals ag001

variables:
  # Ajuste se precisar, mas mantenha consistente com seu RG/tenant
  location: 'westus3'
  resourceGroupName: 'rg-iac-web-iis'
  vmName: 'vm-iac-web-iis'

  # Nome exato da Service Connection no Azure DevOps
  azureServiceConnection: 'ar01com'

  # ARM (VM)
  templateFile: 'arm-templates/vm-iis-template.json'
  parametersFile: 'arm-templates/vm-iis-parameters.json'

  # Script que vai publicar/configurar o site (ex.: baixar index.html e copiar para inetpub)
  scriptUrl: 'https://raw.githubusercontent.com/lmlpuc/lmlarm003/refs/heads/main/src/scripts/site.ps1'

stages:
- stage: DeployInfra
  displayName: 'Provisionar Infraestrutura (VM)'
  jobs:
  - job: Deploy
    displayName: 'Criar RG + Deploy ARM (VM)'
    steps:
    - checkout: self

    - powershell: |
        Write-Host "Workspace: $(System.DefaultWorkingDirectory)"
        Write-Host "Listando arm-templates:"
        dir "$(System.DefaultWorkingDirectory)\arm-templates" -Force
      displayName: 'Debug: listar arquivos arm-templates'

    - task: AzureCLI@2
      displayName: 'Criar Resource Group (se não existir)'
      inputs:
        azureSubscription: '$(azureServiceConnection)'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          $rg  = "$(resourceGroupName)"
          $loc = "$(location)"

          Write-Host "Verificando se o RG existe: $rg"
          $exists = az group exists --name $rg

          if ($exists -eq "false") {
            Write-Host "RG não existe. Criando em $loc..."
            az group create --name $rg --location $loc
          }
          else {
            Write-Host "RG já existe. Seguindo sem recriar."
          }

    - task: AzureResourceManagerTemplateDeployment@3
      displayName: 'Deploy ARM Template (VM)'
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: '$(azureServiceConnection)'
        action: 'Create Or Update Resource Group'
        resourceGroupName: '$(resourceGroupName)'
        location: '$(location)'
        templateLocation: 'Linked artifact'
        csmFile: '$(templateFile)'
        csmParametersFile: '$(parametersFile)'
        deploymentMode: 'Incremental'
        deploymentName: 'vm-iis-deployment'

- stage: ConfigureWebsite
  displayName: 'Publicar site no IIS (CustomScriptExtension)'
  dependsOn: DeployInfra
  condition: succeeded()
  jobs:
  - job: PublishIIS
    displayName: 'Aguardar VM + Executar CustomScriptExtension'
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: 'Aguardar VM ficar disponível'
      inputs:
        azureSubscription: '$(azureServiceConnection)'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          $rg = "$(resourceGroupName)"
          $vm = "$(vmName)"

          Write-Host "Aguardando VM existir: $vm em $rg"
          $max = 30
          for ($i=1; $i -le $max; $i++) {
            az vm show -g $rg -n $vm 1>$null 2>$null
            if ($LASTEXITCODE -eq 0) {
              Write-Host "VM encontrada!"
              break
            }
            Write-Host "VM ainda não encontrada... tentativa $i/$max"
            Start-Sleep -Seconds 10
          }

          az vm show -g $rg -n $vm 1>$null 2>$null
          if ($LASTEXITCODE -ne 0) {
            throw "VM '$vm' não foi encontrada no RG '$rg'. Verifique se o ARM template criou a VM com esse nome."
          }

    - task: AzureCLI@2
      displayName: 'Executar CustomScriptExtension (site.ps1)'
      inputs:
        azureSubscription: '$(azureServiceConnection)'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          $vmName = "$(vmName)"
          $resourceGroup = "$(resourceGroupName)"
          $scriptUrl = "$(scriptUrl)"

          $settings = @{
            fileUris = @($scriptUrl)
            commandToExecute = "powershell -ExecutionPolicy Unrestricted -File site.ps1"
          }

          $jsonFile = Join-Path $env:TEMP "customScriptSettings.json"
          $settings | ConvertTo-Json -Depth 5 | Out-File -FilePath $jsonFile -Encoding ascii

          az vm extension set `
            --resource-group $resourceGroup `
            --vm-name $vmName `
            --name CustomScriptExtension `
            --publisher Microsoft.Compute `
            --settings "@$jsonFile"
